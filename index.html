<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calling Card ‚Äî Persona vibe</title>
  <meta name="theme-color" content="#e60012" />

  <!-- √°udio -->
  <link rel="preload" href="assets/audio/calling-card-theme.mp3" as="audio" />

  <!-- fonte (diret√≥rio informado) -->
  <link rel="preload" href="assets/fonts/persona_font4.ttf" as="font" type="font/ttf" crossorigin>

  <!-- fallback (HUD) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* ======== Fonte Persona ======== */
    @font-face{
      font-family: "P5Persona";
      src: url("assets/fonts/persona_font4.ttf") format("opentype");
      font-weight: 400 900;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --p5-font: "P5Persona", Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* >>> CONTROLES VISUAIS (fixos no ‚Äúlook de PC‚Äù) <<< */
      --paper-pad: 72px;              /* espa√ßo interno do papel */
      --measure: 62ch;                /* largura m√°x. do texto corrido */
      --letter-w: 840px;              /* largura da carta/papel */

      /* >>> √ÅREA DE SEGURAN√áA DO TEXTO (EVITA CORTAR NO TOPO/BASE) <<< */
      --safe-top: 72px;               /* afasta do topo inclinado */
      --safe-bottom: 92px;            /* afasta da base inclinada */
      --edge-gap: 24px;               /* espa√ßo acima da faixa decorativa */

      /* >>> TEXTO DA CARTA <<< */
      --letter-size: 36px;            /* FIXO para manter visual do PC */
      --letter-lh: 1.7;
      --letter-p-gap: 100px;          /* espa√ßamento s√≥ entre par√°grafos */
      --word-gap: 0.18em;             /* espa√ßamento ENTRE PALAVRAS */

      /* >>> ALTURA/ANIMA√á√ÉO DA CARTA <<< */
      --letter-closed-h: 0px;         /* altura inicial (fechada) */
      --letter-speed: .9s;

      /* Selo (na aba) */
      --seal-size: 200px;
      --seal-top: 50%;

      /* Decora√ß√£o abaixo do tri√¢ngulo (sobre o corpo) */
      --decor-w: 360px;
      --decor-top: 64%;

      --red:#e60012;
      --black:#0b0b0c;
      --white:#ffffff;
      --paper:#ffffff;
      --shadow: rgba(0,0,0,.50);
      --bg:url("assets/img/p5-bg.png");

      /* >>> AUTO-SCALE (preenchido via JS) <<< */
      --scale: 1;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; background:#000; color:var(--white);
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* ======== CEN√ÅRIO ======== */
    .stage{
      min-height: 100dvh;
      position: relative;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 24px 20px 96px;

      background:
        radial-gradient(1200px 800px at 10% -20%, rgba(0,0,0,.65), transparent 60%),
        radial-gradient(900px 900px at 110% 120%, rgba(0,0,0,.55), transparent 60%),
        var(--bg);
      background-size: cover, cover, cover;
      background-position: center, center, center;
      background-attachment: fixed;
      isolation:isolate;
    }

    /* ======== HUD ======== */
    .hud{
      position:fixed; inset:16px 16px auto auto; z-index:10; display:flex; gap:10px; align-items:center
    }
    .btn{
      appearance:none; border:0; cursor:pointer; user-select:none;
      padding:12px 14px; border-radius:12px; font-weight:900;
      text-transform:uppercase; letter-spacing:.08em;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: transform .15s ease, opacity .2s ease, background .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99) }
    .btn-music{ background:linear-gradient(90deg, var(--red), #ff3d4d); color:#fff }
    .btn-music[aria-pressed="false"]{ background:#15151d; color:#ddd; border:1px solid rgba(255,255,255,.25) }

    /* ======== AUTO-SCALE WRAPPER ======== */
    #autoScale{
      position: relative;
      width: 100%;
      display: flex;
      justify-content: center;
      min-height: 0;
    }
    #scaleInner{
      width: 1024px;                 /* BASE_W no JS */
      transform-origin: top center;
      transform: scale(var(--scale));
      -webkit-transform: translateZ(0) scale(var(--scale));
    }

    /* ======== ENVELOPE ======== */
    .wrap{ position:relative; z-index:2; width:var(--letter-w); margin: 0 auto; }

    .envelope{
      position:relative;
      width:var(--letter-w);
      aspect-ratio: 16/10;
      margin: 8px auto 0;
      transform: translateY(0);
      transition: transform .6s ease;
      cursor:pointer;
      filter: drop-shadow(0 30px 70px var(--shadow));
      perspective: 1200px;
      transform-style: preserve-3d;
    }

    .envelope .body{
      position:absolute; inset:0;
      border-radius: 18px;
      background: linear-gradient(#fff,#f7f7f7);
      border: 4px solid #000;
      z-index:1;
    }

    .flap-group{
      position:absolute; inset:0;
      transform-origin: top center;
      transition: transform .7s cubic-bezier(.2,.8,.2,1);
      z-index:3;
      transform-style: preserve-3d;
    }
    .envelope.open .flap-group{ transform: rotateX(150deg); }

    .flap-edge{
      position:absolute; inset: -2px;
      clip-path: polygon(0 0,100% 0,100% 56%,50% 86%,0 56%);
      background:#000; border-radius: 30px 30px 40px 40px;
      z-index:1;
    }
    .flap{
      position:absolute; inset:0;
      clip-path: polygon(0 0,100% 0,100% 56%,50% 86%,0 56%);
      background: linear-gradient(#fff,#f3f3f3);
      border-radius: 30px 30px 30px 30px;
      z-index:2;
    }

    /* SELO (imagem) dentro da flap-group */
    .seal{
      position:absolute;
      left:50%;
      top:var(--seal-top);
      transform: translate(-50%,-50%);
      width:var(--seal-size);
      height:var(--seal-size);
      padding:0;
      border:none;
      background:transparent;
      cursor:pointer;
      z-index:3;
    }
    .seal:focus-visible{ outline:0px solid #fff; outline-offset:4px }
    .seal > img{ width:100%; height:100%; display:block; object-fit:contain; border-radius:0; box-shadow:none; pointer-events:none; }

    /* DECORA√á√ÉO ABAIXO DO TRI√ÇNGULO (sobre o corpo) */
    .decoration{
      position:absolute;
      left:50%;
      top: var(--top, var(--decor-top));
      transform: translate(-50%, 0) rotate(var(--rot, 0deg));
      width: var(--w, var(--decor-w));
      height:auto;
      z-index:2;
      pointer-events:none;
      image-rendering: -webkit-optimize-contrast;
    }

    .envelope.open{ transform: translateY(-8px) }

    /* ======== CARTA ======== */
    .letter{
      position:relative; width:var(--letter-w); margin:24px auto 0;
      max-height: var(--letter-closed-h);  /* come√ßa fechada */
      opacity: 0;
      overflow:hidden;                     /* impede vazar enquanto anima */
      transition:
        max-height var(--letter-speed) ease .1s,
        opacity .25s ease .05s;
      background: transparent;
      border-radius:16px;
      z-index:0;
    }
    .letter.show{ opacity: 1; }

    .letter.scroll.show{
      max-height: min(var(--_openH, 9999px), 82vh);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background-clip: padding-box;
    }

    /* Papel e camadas internas */
    .paper{
      position:relative;
      margin: 10px;
      padding: var(--paper-pad);
      background: var(--paper);
      color:#111;
      border: 4px solid #000;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      clip-path: polygon(2% 4%, 98% 0%, 100% 6%, 96% 12%, 100% 18%, 98% 24%, 100% 30%, 98% 36%, 100% 42%, 98% 48%, 100% 54%, 98% 60%, 100% 66%, 96% 72%, 100% 78%, 98% 84%, 100% 90%, 98% 96%, 2% 100%, 0% 94%, 4% 88%, 0% 82%, 4% 76%, 0% 70%, 4% 64%, 0% 58%, 4% 52%, 0% 46%, 4% 40%, 0% 34%, 4% 28%, 0% 22%, 4% 16%, 0% 10%);
      overflow:hidden;
    }

    .paper-decor--under{ pointer-events:none; position:absolute; inset:0; z-index:1; }

    .paper-content{
      position:relative; z-index:3;
      cursor: pointer;
      font-family: var(--p5-font);
      letter-spacing: .02em;

      overflow-wrap: anywhere;
      word-break: normal;
      hyphens: auto;

      max-width: var(--measure);
      width: 100%;
      margin-inline: auto;

      /* >>> √ÅREA DE SEGURAN√áA <<< */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    .paper-content p{
      font-size: var(--letter-size);
      line-height: var(--letter-lh);
      margin: 0 0 var(--letter-p-gap);
      word-spacing: var(--word-gap);
    }
    .paper-content p:last-child{ margin-bottom: 0; }

    .paper-decor--over{ pointer-events:none; position:absolute; inset:0; z-index:4; }

    .text-decor{
      position:absolute;
      left: var(--x, 50%); top: var(--y, 50%);
      transform: translate(-50%, -50%) rotate(var(--rot, 0deg));
      width: var(--w, 220px); height:auto;
      opacity: var(--op, .85);
      image-rendering: -webkit-optimize-contrast;
      mix-blend-mode: multiply;
    }

    .edge{
      width:100%; height:12px; margin: var(--edge-gap) auto 0;
      background:
        linear-gradient(90deg, #fff 0 8%, transparent 8% 12%, var(--red) 12% 24%, transparent 24% 28%,
                                #fff 28% 32%, transparent 32% 36%, #ff7280 36% 48%, transparent 48% 52%,
                                #fff 52% 56%, transparent 56% 60%, var(--red) 60% 76%, transparent 76% 80%,
                                #fff 80% 84%, transparent 84% 88%, #ff7280 88% 100%);
      filter: drop-shadow(0 -2px 8px rgba(230,0,18,.35));
      border-radius:10px;
    }

    /* ======== OVERLAY FORA DA CARTA ======== */
    .overlay-layer{
      position:absolute;
      inset:0;
      z-index:40;
      pointer-events:none; /* n√£o bloqueia cliques */
    }
    .overlay-decor{
      position:absolute;
      left: var(--x, 50%); top: var(--y, 50%);
      transform: translate(-50%, -50%) rotate(var(--rot, 0deg)) scale(.94);
      width: var(--w, 320px); height:auto;
      opacity:0;
      filter: saturate(1) contrast(1);
      image-rendering: -webkit-optimize-contrast;
      transition: opacity .45s ease, transform .55s cubic-bezier(.2,.8,.2,1);
      will-change: transform, opacity;
    }
    .overlay-active .overlay-decor{
      opacity: var(--op, .95);
      transform: translate(-50%, -50%) rotate(var(--rot, 0deg)) scale(1);
    }

    @media (prefers-reduced-motion: reduce){
      .envelope, .flap-group, .letter{ transition:none }
      .overlay-decor{ transition:none }
    }

    /* ======== LOCKSCREEN (senha de 6 d√≠gitos) ======== */
    .lockscreen{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: grid;
      place-items: center;
      background: #000;
      padding: 24px;
      transition: opacity .35s ease, visibility 0s linear .35s;
    }
    .lockscreen.hidden{
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .lock-panel{
      width: min(520px, 92vw);
      background: #0b0b0c;
      border: 3px solid #fff;
      border-radius: 18px;
      padding: 22px 22px 18px;
      text-align: center;
      box-shadow: 0 22px 60px rgba(0,0,0,.6);
    }
    .lock-title{
      font-family: var(--p5-font);
      font-size: 28px;
      margin: 0 0 6px;
      letter-spacing: .04em;
    }
    .lock-sub{ color: #d9d9d9; margin: 0 0 14px; font-size: 14px }
    .pin{
      display:flex; gap:12px; justify-content:center; margin: 10px 0 14px;
    }
    .pin input{
      width: 56px; height: 68px;
      font-size: 28px; text-align:center;
      border: 3px solid #fff; border-radius: 12px;
      background: #111; color:#fff; outline: none;
      transition: transform .1s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .pin input:focus{
      border-color: var(--red);
      box-shadow: 0 0 0 4px rgba(230,0,18,.25);
      transform: translateY(-2px);
    }
    .lock-btn{
      appearance:none; border:0; cursor:pointer;
      padding: 12px 16px; border-radius: 12px;
      font-weight: 900; letter-spacing: .06em; text-transform: uppercase;
      background: linear-gradient(90deg, var(--red), #ff3d4d); color: #fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .lock-error{ min-height: 1.4em; color: #ff8088; font-weight: 700; margin-top: 8px }
    .shake{ animation: lockshake .28s ease 0s 2 }
    @keyframes lockshake{
      0%,100%{ transform: translateX(0) }
      25%{ transform: translateX(-6px) }
      75%{ transform: translateX(6px) }
    }
  </style>
</head>
<body>
  <!-- ======== TELA DE SENHA ======== -->
  <div class="lockscreen" id="lockscreen" aria-modal="true" role="dialog" aria-label="Digite a senha">
    <div class="lock-panel" id="lockPanel">
      <h2 class="lock-title">Acesso restrito</h2>
      <p class="lock-sub">Digite a senha de <strong>6 d√≠gitos</strong> para continuar.</p>
      <form id="lockForm" autocomplete="one-time-code">
        <div class="pin">
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 1" />
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 2" />
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 3" />
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 4" />
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 5" />
          <input class="digit" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito 6" />
        </div>
        <button class="lock-btn" type="submit">Entrar</button>
        <div class="lock-error" id="lockError"></div>
      </form>
    </div>
  </div>

  <div class="stage" aria-hidden="true">
    <div class="hud">
      <button id="musicToggle" class="btn btn-music" aria-pressed="true" aria-label="M√∫sica ligada">üéµ ON</button>
    </div>

    <!-- AUTO-SCALE: tudo dentro de #scaleInner √© ‚Äúo seu PC‚Äù -->
    <div id="autoScale">
      <div id="scaleInner">
        <div class="wrap" id="wrap">
          <!-- ENVELOPE -->
          <div class="envelope" id="envelope" aria-label="Envelope ‚Äî clique no selo para abrir">
            <div class="body" aria-hidden="true"></div>

            <!-- GRUPO QUE SOBE: contorno + aba + SELO -->
            <div class="flap-group">
              <div class="flap-edge" aria-hidden="true"></div>
              <div class="flap" aria-hidden="true"></div>
              <button class="seal" id="sealBtn" aria-label="Abrir pelo selo">
                <img src="assets/img/wax-seal.png" alt="Selo">
              </button>
            </div>

            <!-- DECORA√á√ÉO (abaixo do tri√¢ngulo, sobre o corpo do envelope) -->
            <!-- Edite/duplique estas imagens e ajuste left/top/width/rotate/scale no style -->
            <img
              class="decoration"
              src="assets/img/overlay-decor-4.png"
              alt="" aria-hidden="true"
              style="left: 50%; top: 30%; width: 260px; transform: translate(-50%,0) rotate(0deg) scale(1.15); opacity:1; z-index:2;"
            />
            <img
              class="decoration"
              src="assets/img/overlay-decor-1.png"
              alt="" aria-hidden="true"
              style="left: 68%; top: 10%; width: 200px; transform: translate(-50%,0) rotate(-6deg) scale(1); opacity:1; z-index:2;"
            />
            <img
              class="decoration"
              src="assets/img/overlay-decor-6.png"
              alt="" aria-hidden="true"
              style="left: 50%; top: -25%; width: 400px; transform: translate(-50%,0) rotate(0deg) scale(1); opacity:1; z-index:2;"
            />
            <img
              class="decoration"
              src="assets/img/overlay-decor-9.png"
              alt="" aria-hidden="true"
              style="left: 20%; top: 30%; width: 200px; transform: translate(-50%,0) rotate(-6deg) scale(1); opacity:1; z-index:2;"
            />
            <img
              class="decoration"
              src="assets/img/overlay-decor-10.png"
              alt="" aria-hidden="true"
              style="left: 80%; top: 35%; width: 200px; transform: translate(-50%,0) rotate(-6deg) scale(1); opacity:1; z-index:2;"
            />
          </div>

          <!-- CARTA -->
          <section class="letter" id="letter" aria-live="polite">
            <div class="paper" id="paper">
              <div class="paper-decor--under"></div>

              <!-- CONTE√öDO DO TEXTO (clic√°vel para FECHAR) -->
              <div class="paper-content" id="paperContent" role="button" tabindex="0" title="Clique para fechar">
                <p>¬≠¬≠¬≠„Ö§„Ö§</p>
                <p>Ontem, quando voc√™ me disse que estaria disposta a dar uma chance, meu cora√ß√£o se aliviou como n√£o sentia h√° muito tempo. Eu sei que n√≥s erramos, eu falhei contigo e voc√™ comigo, mas continuo acreditando que a nossa hist√≥ria n√£o precisa acabar assim.</p>
                <p>Eu n√£o estou aqui para te cobrar nada, nem para for√ßar sentimentos. S√≥ quero viver essa chance que voc√™ mesma ofereceu: sair, conversar, rir, jogar‚Ä¶ e reencontrar aquele amor rom√¢ntico que sempre foi s√≥ nosso.</p>
                <p>Eu reconhe√ßo os erros que cometi, e sei a dor que te causei. Mas aprendi com isso e estou disposto a ser melhor, porque voc√™ merece essa vers√£o de mim. Sobre o que aconteceu entre n√≥s, n√£o quero mais viver preso √†s m√°goas. Eu te perdoo, e espero que com o tempo voc√™ tamb√©m consiga me perdoar.</p>
                <p>Mas n√£o pense que isso √© apenas uma s√∫plica comum. Hoje, neste parque, o mesmo em que gravamos nossas iniciais dentro de um cora√ß√£o naquela √°rvore, s√≠mbolo de quatro anos lado a lado, eu declaro minha verdadeira miss√£o a partir de hoje: roubar de volta o seu cora√ß√£o, revelar o seu tesouro e reconquistar o amor rom√¢ntico que sempre foi s√≥ nosso.</p>
                <p>Prepare-se, Lady Moon. Assim como os Phantom Thieves, eu n√£o falho em minha miss√£o. Depois desse dia, diante dessa √°rvore que ainda guarda nosso s√≠mbolo, eu irei te abra√ßar‚Ä¶ e, se me permitir, eu vou te beijar como nunca antes.</p>
                <p>E ent√£o, diante de tudo que passamos e de tudo que ainda podemos viver, n√£o quero apenas roubar o seu cora√ß√£o‚Ä¶ quero tamb√©m que voc√™ volte a ser minha namorada, para juntos escrevermos o pr√≥ximo cap√≠tulo da nossa hist√≥ria.</p>
                <p>Posso roubar o seu cora√ß√£o‚Ä¶ e voltar a ser o seu namorado?</p>
                <p class="sig">‚Äî Spike, o ladr√£o que nunca desistiu de voc√™, e nunca ir√°.</p>

                <p>¬≠¬≠¬≠„Ö§„Ö§</p>
                <p>¬≠¬≠¬≠„Ö§„Ö§</p>
                <p>¬≠¬≠¬≠„Ö§„Ö§</p>
                <div class="edge" aria-hidden="true"></div>
              </div>

              <div class="paper-decor--over"></div>
            </div>
          </section>

          <!-- OVERLAY POR CIMA DE TUDO DA CARTA -->
          <div class="overlay-layer" id="overlayLayer">
            <img class="overlay-decor"
                 src="assets/img/overlay-decor-2.png"
                 alt="" aria-hidden="true"
                 style="--x: 78%; --y: 13%; --w: 320px; --rot: 0deg; --op: 1;" />
            <img class="overlay-decor"
                 src="assets/img/overlay-decor-3.png"
                 alt="" aria-hidden="true"
                 style="--x: 78%; --y: 15%; --w: 200px; --rot: -15deg; --op: 1;" />
            <img class="overlay-decor"
                 src="assets/img/overlay-decor-5.png"
                 alt="" aria-hidden="true"
                 style="--x: 85%; --y: 83%; --w: 150px; --rot: 0deg; --op: .98;" />
            <img class="overlay-decor"
                 src="assets/img/overlay-decor-7.png"
                 alt="" aria-hidden="true"
                 style="--x: 50%; --y: 92%; --w: 600px; --rot: 0deg; --op: .98;" />
            <img class="overlay-decor"
                 src="assets/img/overlay-decor-8.png"
                 alt="" aria-hidden="true"
                 style="--x: 50%; --y: 87%; --w: 100px; --rot: 0deg; --op: .98;" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- √ÅUDIO -->
  <audio id="bgm" src="assets/audio/calling-card-theme.mp3" loop preload="auto"></audio>

  <script>
    // ======= PASSWORD GATE =======
    const PASS = '120321'; // <<< TROQUE SUA SENHA AQUI (6 d√≠gitos)
    let isUnlocked = false;

    const lock = document.getElementById('lockscreen');
    const lockPanel = document.getElementById('lockPanel');
    const lockForm = document.getElementById('lockForm');
    const lockError = document.getElementById('lockError');
    const digitInputs = Array.from(lockForm.querySelectorAll('.digit'));

    function focusFirst(){ digitInputs[0].focus(); }

    digitInputs.forEach((inp, i)=>{
      inp.addEventListener('input', ()=>{
        // mant√©m s√≥ n√∫mero e 1 char
        inp.value = inp.value.replace(/\D/g,'').slice(0,1);
        if(inp.value && i < digitInputs.length-1){
          digitInputs[i+1].focus();
        }
      });
      inp.addEventListener('keydown', (e)=>{
        if(e.key === 'Backspace' && !inp.value && i>0){
          digitInputs[i-1].focus();
        }
        if(e.key === 'ArrowLeft' && i>0){
          e.preventDefault(); digitInputs[i-1].focus();
        }
        if(e.key === 'ArrowRight' && i<digitInputs.length-1){
          e.preventDefault(); digitInputs[i+1].focus();
        }
      });
    });

    function getCode(){ return digitInputs.map(d=>d.value).join(''); }
    function clearCode(){ digitInputs.forEach(d=>d.value=''); focusFirst(); }

    lockForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const code = getCode();
      if(code.length !== 6){
        lockError.textContent = 'Complete os 6 d√≠gitos';
        lockPanel.classList.add('shake'); setTimeout(()=>lockPanel.classList.remove('shake'), 320);
        return;
      }
      if(code === PASS){
        isUnlocked = true;
        lock.classList.add('hidden');
        document.querySelector('.stage')?.setAttribute('aria-hidden','false');
      }else{
        lockError.textContent = 'Senha incorreta';
        lockPanel.classList.add('shake'); setTimeout(()=>lockPanel.classList.remove('shake'), 320);
        clearCode();
      }
    });

    window.addEventListener('load', focusFirst);

    // ======= AUTO-SCALE =======
    const BASE_W = 1024; // largura base do seu layout no PC
    const autoScale   = document.getElementById('autoScale');
    const scaleInner  = document.getElementById('scaleInner');

    function applyScale(){
      const vw = Math.max(320, window.innerWidth);
      const s = Math.min(vw / BASE_W, 1);
      document.documentElement.style.setProperty('--scale', s);
      const targetH = scaleInner.scrollHeight * s;
      autoScale.style.height = targetH + 'px';
    }
    addEventListener('load', applyScale, {once:true});
    addEventListener('resize', applyScale);
    addEventListener('orientationchange', ()=>setTimeout(applyScale, 60));

    // ======= L√ìGICA EXISTENTE =======
    const envelope     = document.getElementById('envelope');
    const sealBtn      = document.getElementById('sealBtn');
    const letter       = document.getElementById('letter');
    const bgm          = document.getElementById('bgm');
    const toggle       = document.getElementById('musicToggle');
    const overlay      = document.getElementById('overlayLayer');
    const paperContent = document.getElementById('paperContent');
    const rootStyles   = getComputedStyle(document.documentElement);

    let hasInteracted = false;

    function startMusicOnce(){
      if(!isUnlocked) return; // bloqueia antes da senha
      if(hasInteracted) return;
      hasInteracted = true;
      safePlay();
    }

    function safePlay(){
      bgm.loop = true;
      const p = bgm.play();
      if(p && typeof p.catch === 'function'){ p.catch(()=>{}); }
      toggle.setAttribute('aria-pressed','true');
      toggle.textContent = 'üéµ ON';
    }

    function fadeTo(targetVol=1, ms=350){
      const steps = 18, step = (targetVol - bgm.volume)/steps;
      let i=0;
      const id = setInterval(()=>{
        bgm.volume = Math.max(0, Math.min(1, bgm.volume + step));
        if(++i>=steps){ bgm.volume = targetVol; clearInterval(id); if(targetVol===0){ bgm.pause(); } }
      }, ms/steps);
    }

    function setOpenHeight(){
      const target = letter.scrollHeight;
      letter.style.setProperty('--_openH', target + 'px'); // √∫til p/ .letter.scroll.show
      letter.style.maxHeight = target + 'px';
      applyScale();
    }

    function openLetter(){
      if(!isUnlocked) return; // bloqueia antes da senha
      envelope.classList.add('open'); // abre o tri√¢ngulo
      letter.classList.add('show');
      requestAnimationFrame(()=>{ setOpenHeight(); });

      const onEnd = (ev)=>{
        if(ev.target === letter && ev.propertyName === 'max-height'){
          overlay.classList.add('overlay-active');  // ativa TODOS os .overlay-decor
          letter.removeEventListener('transitionend', onEnd);
          applyScale(); // garante ajuste final
        }
      };
      letter.addEventListener('transitionend', onEnd);
    }

    function closeLetter(){
      if(!isUnlocked) return; // bloqueia antes da senha
      overlay.classList.remove('overlay-active');
      envelope.classList.remove('open'); // fecha o tri√¢ngulo

      const closed = rootStyles.getPropertyValue('--letter-closed-h').trim() || '0px';
      letter.style.maxHeight = closed;
      const onEnd = (ev)=>{
        if(ev.target === letter && ev.propertyName === 'max-height'){
          letter.classList.remove('show');
          letter.removeEventListener('transitionend', onEnd);
          applyScale();
        }
      };
      letter.addEventListener('transitionend', onEnd);
    }

    // Recalcula auto-scale ap√≥s imagens decorativas/carregarem
    document.querySelectorAll('.overlay-decor, .decoration').forEach(img=>{
      if(img.complete) return;
      img.addEventListener('load', applyScale);
    });

    // 1¬∫ clique em qualquer parte do envelope: s√≥ inicia a m√∫sica
    envelope.addEventListener('click', startMusicOnce);

    // Abrir SOMENTE pelo selo
    sealBtn.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      startMusicOnce();
      openLetter();
    });

    // Fechar: clicando na √°rea do texto
    paperContent.addEventListener('click', closeLetter);

    // Teclado (acessibilidade): Enter/Espa√ßo fecha
    paperContent.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        closeLetter();
      }
    });

    // bot√£o de m√∫sica
    toggle.addEventListener('click', ()=>{
      if(!isUnlocked) return; // bloqueia antes da senha
      const on = toggle.getAttribute('aria-pressed') === 'true';
      if(on){
        toggle.setAttribute('aria-pressed','false');
        toggle.textContent = 'üîá OFF';
        fadeTo(0, 300);
      }else{
        toggle.setAttribute('aria-pressed','true');
        toggle.textContent = 'üéµ ON';
        if(bgm.paused){ bgm.volume = 0; safePlay(); }
        fadeTo(1, 300);
      }
    });

    // acessibilidade: Enter/Espa√ßo no selo abre
    sealBtn.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        startMusicOnce();
        openLetter();
      }
    });
  </script>
</body>
</html>
